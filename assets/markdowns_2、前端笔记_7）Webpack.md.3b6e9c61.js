import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.867ce416.js";const E=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"markdowns/2、前端笔记/7）Webpack.md","filePath":"markdowns/2、前端笔记/7）Webpack.md"}'),p={name:"markdowns/2、前端笔记/7）Webpack.md"},o=l(`<h2 id="前端工程化" tabindex="-1">前端工程化 <a class="header-anchor" href="#前端工程化" aria-label="Permalink to &quot;前端工程化&quot;">​</a></h2><p>前端工程化指的是：在企业级的前端项目开发中，把前端开发所需的工具、技术、流程、经验等进行规范化、标准化。</p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858676.png" alt="截图" style="zoom:50%;"><p><strong>package.json</strong></p><ol><li>dependencies：开发以及上线后所需要的包（-S == --save）</li><li>devDependencies：仅在开发阶段所需要的包（-D == --save-dev）</li></ol><br><br><h3 id="webpack-的基本使用" tabindex="-1">webpack 的基本使用 <a class="header-anchor" href="#webpack-的基本使用" aria-label="Permalink to &quot;webpack 的基本使用&quot;">​</a></h3><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858129.png" alt="截图" style="zoom:50%;"><h4 id="webpack-安装与配置" tabindex="-1">webpack 安装与配置 <a class="header-anchor" href="#webpack-安装与配置" aria-label="Permalink to &quot;webpack 安装与配置&quot;">​</a></h4><p><strong>安装</strong></p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858043.png" alt="截图" style="zoom:80%;"><p><strong>配置</strong></p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858938.png" alt="截图" style="zoom:80%;"><p>mode，用来指定构建模式。可选值有 development（开发模式）和 production（上线阶段）</p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858125.png" alt="截图" style="zoom:80%;"><p><strong>默认约定</strong></p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858674.png" alt="截图" style="zoom:50%;"><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858315.png" alt="截图" style="zoom:80%;"><br><h4 id="webpack-中的插件" tabindex="-1">webpack 中的插件 <a class="header-anchor" href="#webpack-中的插件" aria-label="Permalink to &quot;webpack 中的插件&quot;">​</a></h4><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858971.png" alt="截图" style="zoom:80%;"><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858945.png" alt="截图" style="zoom:80%;"><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858568.png" alt="截图" style="zoom:80%;"><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858052.png" alt="截图" style="zoom:80%;"><h4 id="webpack-中的-loader" tabindex="-1">webpack 中的 loader <a class="header-anchor" href="#webpack-中的-loader" aria-label="Permalink to &quot;webpack 中的 loader&quot;">​</a></h4><p>loader 加载器的作用：协助 webpack 打包处理特定的文件模块。</p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858200.png" alt="截图" style="zoom:67%;"><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858988.png" alt="截图" style="zoom:67%;"><p><strong>loader 的安装与配置</strong></p><p>style-loader、css-loader、less-loader</p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858545.png" alt="截图" style="zoom:67%;"><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858905.png" alt="截图" style="zoom:67%;"><p><strong>打包处理图片</strong></p><p>url-loader、file-loader</p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858558.png" alt="截图" style="zoom:80%;"><br><p><strong>loader 的另一种配置方式</strong></p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858317.png" alt="image-20230412105447276"></p><p><strong>打包处理 js 文件中的高级语法</strong></p><p>babel-loader、babel/core、babel/plugin-proposal-decorators</p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858199.png" alt="image-20230412110042258"></p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151858291.png" alt="image-20230412110013122"></p><p><strong>总结</strong></p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859409.png" alt="截图" style="zoom:50%;"><br><br><h3 id="发布" tabindex="-1">发布 <a class="header-anchor" href="#发布" aria-label="Permalink to &quot;发布&quot;">​</a></h3><h4 id="配置-build-命令" tabindex="-1">配置 build 命令 <a class="header-anchor" href="#配置-build-命令" aria-label="Permalink to &quot;配置 build 命令&quot;">​</a></h4><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859680.png" alt="截图" style="zoom:80%;"><h4 id="目录划分" tabindex="-1">目录划分 <a class="header-anchor" href="#目录划分" aria-label="Permalink to &quot;目录划分&quot;">​</a></h4><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859136.png" alt="image-20230412110947361"></p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859015.png" alt="image-20230412111007684"></p><h4 id="自动清除-dist-目录下的旧文件" tabindex="-1">自动清除 dist 目录下的旧文件 <a class="header-anchor" href="#自动清除-dist-目录下的旧文件" aria-label="Permalink to &quot;自动清除 dist 目录下的旧文件&quot;">​</a></h4><p>在 webpack.config.js 下：</p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859568.png" alt="image-20230412111150710"></p><h3 id="source-map" tabindex="-1">Source Map <a class="header-anchor" href="#source-map" aria-label="Permalink to &quot;Source Map&quot;">​</a></h3><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859723.png" alt="截图"></p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859814.png" alt="截图" style="zoom:80%;"><br><h4 id="配置-source-map" tabindex="-1">配置 Source Map <a class="header-anchor" href="#配置-source-map" aria-label="Permalink to &quot;配置 Source Map&quot;">​</a></h4><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859051.png" alt="截图" style="zoom:80%;"><br><h4 id="发布时关闭-source-map" tabindex="-1">发布时关闭 Source Map <a class="header-anchor" href="#发布时关闭-source-map" aria-label="Permalink to &quot;发布时关闭 Source Map&quot;">​</a></h4><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859254.png" alt="截图" style="zoom:80%;"><br><h4 id="只定位行数不暴露源码" tabindex="-1">只定位行数不暴露源码 <a class="header-anchor" href="#只定位行数不暴露源码" aria-label="Permalink to &quot;只定位行数不暴露源码&quot;">​</a></h4><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859692.png" alt="截图" style="zoom:80%;"><br><h4 id="最佳策略" tabindex="-1">最佳策略 <a class="header-anchor" href="#最佳策略" aria-label="Permalink to &quot;最佳策略&quot;">​</a></h4><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859194.png" alt="截图" style="zoom:80%;"><br><br><h3 id="webpack-中-的配置" tabindex="-1">webpack 中‘@’的配置 <a class="header-anchor" href="#webpack-中-的配置" aria-label="Permalink to &quot;webpack 中‘@’的配置&quot;">​</a></h3><p>在 webpack.config.js 的 module.exports = {} 中加入：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#80A665;">resolve</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">alias</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">@</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">./src/</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#59873A;">resolve</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">alias</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">@</span><span style="color:#B5695999;">&#39;</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">./src/</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span></code></pre></div><br><br><h2 id="手写-webpack" tabindex="-1">手写 Webpack <a class="header-anchor" href="#手写-webpack" aria-label="Permalink to &quot;手写 Webpack&quot;">​</a></h2><h3 id="npx" tabindex="-1">npx <a class="header-anchor" href="#npx" aria-label="Permalink to &quot;npx&quot;">​</a></h3><h4 id="npx-是什么" tabindex="-1"><strong>npx 是什么</strong> <a class="header-anchor" href="#npx-是什么" aria-label="Permalink to &quot;**npx 是什么**&quot;">​</a></h4><p>npx 是一个由 Node.js 官方提供的用于快速执行 npm 包中的可执行文件的工具。它可以帮助我们在不全局安装某些包的情况下，直接运行该包提供的命令行工具。npx 会在执行时，检查本地项目中是否安装了对应的依赖，如果没有安装则会自动下载安装，并执行命令。如果本地已经存在该依赖，则直接执行命令。</p><h4 id="npx-会把远端的包下载到本地吗" tabindex="-1"><strong>npx 会把远端的包下载到本地吗?</strong> <a class="header-anchor" href="#npx-会把远端的包下载到本地吗" aria-label="Permalink to &quot;**npx 会把远端的包下载到本地吗?**&quot;">​</a></h4><p>npx 不会像 npm 或 yarn 一样将包下载到本地的 node_modules 目录中。相反，它会在执行命令时，在本地缓存中寻找并下载包，然后执行该包中的命令。这样可以避免在开发过程中在全局安装大量的包，同时也可以确保使用的是最新版本的包。</p><h4 id="npx-执行完成之后-下载的包是否会被删除" tabindex="-1"><strong>npx 执行完成之后， 下载的包是否会被删除？</strong> <a class="header-anchor" href="#npx-执行完成之后-下载的包是否会被删除" aria-label="Permalink to &quot;**npx 执行完成之后， 下载的包是否会被删除？**&quot;">​</a></h4><p>npx 会在执行完命令后删除下载的包。这是因为 npx 会在执行命令之前，将需要执行的包下载到一个临时目录中，并在执行完毕后删除该目录。这样可以避免在本地留下不必要的依赖包。如果需要保留依赖包，可以使用--no-cleanup 选项来禁止删除下载的包。</p><br><h3 id="原理-webpack-如何工作" tabindex="-1"><code>原理</code> webpack 如何工作 <a class="header-anchor" href="#原理-webpack-如何工作" aria-label="Permalink to &quot;\`原理\` webpack 如何工作&quot;">​</a></h3><blockquote><ul><li>npm init -y 自动生成一个 package.json 依赖包管理文件</li><li>如何执行打包命令，如 npx webpack</li><li>打包完输出到 dist 目录，通过 html 文件引入并在浏览器上运行</li><li>npx 可以执行 node_modules 目录下的包</li><li>分析打包生成的文件 bundle.js，明白它的结构，以便自己生成一个这样的文件。</li><li>实现:执行 xx 命令，从 webpack.config.js 打包项目并生成 bundle.js 结构的文件。</li></ul></blockquote><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859236.png" alt="image-20230723153915040"></p><br><h3 id="配置-webpack-config-js" tabindex="-1">配置 webpack.config.js <a class="header-anchor" href="#配置-webpack-config-js" aria-label="Permalink to &quot;配置 webpack.config.js&quot;">​</a></h3><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">path</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">mode</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">development</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//开发模式</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">entry</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./src/index.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//打包入口</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">output</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">filename</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">bundle.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//打包输出的文件名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">path</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">dist</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//打包输出的目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// module:{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//   rules:[</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//     {</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//       test:/\\.less$/,</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//       use:[</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//         // 从上到下</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//        &quot;style-loader&quot;,  //把style写入html</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//        &quot;css-loader&quot;,   //css ---&gt; commonJS</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//        &quot;less-loader&quot;  //把less转css</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//       ]</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//     }</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">//   ]</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// }</span></span>
<span class="line"><span style="color:#666666;">};</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">path</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">mode</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">development</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//开发模式</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">entry</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./src/index.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//打包入口</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">output</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">filename</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">bundle.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//打包输出的文件名</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">path</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">dist</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//打包输出的目录</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// module:{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//   rules:[</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//     {</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//       test:/\\.less$/,</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//       use:[</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//         // 从上到下</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//        &quot;style-loader&quot;,  //把style写入html</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//        &quot;css-loader&quot;,   //css ---&gt; commonJS</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//        &quot;less-loader&quot;  //把less转css</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//       ]</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//     }</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">//   ]</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// }</span></span>
<span class="line"><span style="color:#999999;">};</span></span></code></pre></div><br><h3 id="生成的-bundl-js" tabindex="-1">生成的 bundl.js <a class="header-anchor" href="#生成的-bundl-js" aria-label="Permalink to &quot;生成的 bundl.js&quot;">​</a></h3><blockquote><p><strong>分析 bundle.js 文件</strong> (fun(modules){处理模块加载})(indexfile:fun，jdfile:fun)</p><p>将引用的文件路径补全，如&quot;./jd&quot;转换后是&quot;./jd.js&quot;</p><p>将 require 替换成 webpack 自定义加载函数_<em>webpack_require</em>（递归执行）</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// webpackBootstrap</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_modules__</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./src/index.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_module</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_exports</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__webpack_require__</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">eval</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">let jd = __webpack_require__(/*! ./jd */ &quot;./src/jd.js&quot;)</span><span style="color:#C99076;">\\r\\n\\r\\n</span><span style="color:#C98A7D;">console.log(&quot;jd打包工具：&quot;+jd)</span><span style="color:#C99076;">\\n\\n</span><span style="color:#C98A7D;">//# sourceURL=webpack://01/./src/index.js?</span><span style="color:#C98A7D99;">&#39;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./src/jd.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">module</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">eval</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">let name = &quot;自定义打包工具&quot;</span><span style="color:#C99076;">\\r\\n\\r\\n</span><span style="color:#C98A7D;">module.exports = name</span><span style="color:#C99076;">\\n\\n</span><span style="color:#C98A7D;">//# sourceURL=webpack://01/./src/jd.js?</span><span style="color:#C98A7D99;">&#39;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// The module cache</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_module_cache__</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// The require function</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">__webpack_require__</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Check if module is in cache</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">cachedModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_module_cache__</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">cachedModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">cachedModule</span><span style="color:#666666;">.</span><span style="color:#BD976A;">exports</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Create a new module (and put it into the cache)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">module</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">__webpack_module_cache__</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// no module.id needed</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// no module.loaded needed</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">exports</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Execute the module function</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">__webpack_modules__</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">](</span><span style="color:#B8A965;">module</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_require__</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Return the exports of the module</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_exports__</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">__webpack_require__</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./src/index.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">})();</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// webpackBootstrap</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_modules__</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./src/index.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_module</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_exports</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__webpack_require__</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">eval</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">let jd = __webpack_require__(/*! ./jd */ &quot;./src/jd.js&quot;)</span><span style="color:#A65E2B;">\\r\\n\\r\\n</span><span style="color:#B56959;">console.log(&quot;jd打包工具：&quot;+jd)</span><span style="color:#A65E2B;">\\n\\n</span><span style="color:#B56959;">//# sourceURL=webpack://01/./src/index.js?</span><span style="color:#B5695999;">&#39;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./src/jd.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">module</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">eval</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">let name = &quot;自定义打包工具&quot;</span><span style="color:#A65E2B;">\\r\\n\\r\\n</span><span style="color:#B56959;">module.exports = name</span><span style="color:#A65E2B;">\\n\\n</span><span style="color:#B56959;">//# sourceURL=webpack://01/./src/jd.js?</span><span style="color:#B5695999;">&#39;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// The module cache</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_module_cache__</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// The require function</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">__webpack_require__</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Check if module is in cache</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">cachedModule</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_module_cache__</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">cachedModule</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">cachedModule</span><span style="color:#999999;">.</span><span style="color:#B07D48;">exports</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Create a new module (and put it into the cache)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">module</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">__webpack_module_cache__</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// no module.id needed</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// no module.loaded needed</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">exports</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{},</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Execute the module function</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">__webpack_modules__</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">](</span><span style="color:#998418;">module</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_require__</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Return the exports of the module</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_exports__</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">__webpack_require__</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./src/index.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">})();</span></span></code></pre></div><br><br><h3 id="_01-创建打包命令-jd-pack" tabindex="-1"><code>01</code> 创建打包命令 jd-pack <a class="header-anchor" href="#_01-创建打包命令-jd-pack" aria-label="Permalink to &quot;\`01\` 创建打包命令 jd-pack&quot;">​</a></h3><blockquote><ul><li>创建命令的目录</li><li>生成 package.json</li><li>生成命令，npm link(把本地目录创建全局快捷方式)</li><li>npx jd-pack ---&gt; 全局 ---&gt; 本地</li></ul></blockquote><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859484.png" alt="image-20230723160237894"></p><h4 id="命令行执行文件-jd-pack-js" tabindex="-1">命令行执行文件 jd-pack.js <a class="header-anchor" href="#命令行执行文件-jd-pack-js" aria-label="Permalink to &quot;命令行执行文件 jd-pack.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#758575DD;">#! /usr/bin/env node</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// console.log(&quot;jd打包工具&quot;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">path</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">webpack.config.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// 导入编译器</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Compiler</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">../lib/Compiler</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">compiler</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">Compiler</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// 编译</span></span>
<span class="line"><span style="color:#BD976A;">compiler</span><span style="color:#666666;">.</span><span style="color:#80A665;">run</span><span style="color:#666666;">();</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">#! /usr/bin/env node</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// console.log(&quot;jd打包工具&quot;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">path</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">webpack.config.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// 导入编译器</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Compiler</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">../lib/Compiler</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">compiler</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">Compiler</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// 编译</span></span>
<span class="line"><span style="color:#B07D48;">compiler</span><span style="color:#999999;">.</span><span style="color:#59873A;">run</span><span style="color:#999999;">();</span></span></code></pre></div><br><h4 id="编译器配置文件-compiler-js" tabindex="-1">编译器配置文件 Compiler.js <a class="header-anchor" href="#编译器配置文件-compiler-js" aria-label="Permalink to &quot;编译器配置文件 Compiler.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">path</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// 编译器</span></span>
<span class="line"><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA994;">Compiler</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 入口目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 当前工作目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">process</span><span style="color:#666666;">.</span><span style="color:#80A665;">cwd</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 执行方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">run</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Compiler</span><span style="color:#666666;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">path</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// 编译器</span></span>
<span class="line"><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E8F82;">Compiler</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 入口目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 当前工作目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">process</span><span style="color:#999999;">.</span><span style="color:#59873A;">cwd</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 执行方法</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">run</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Compiler</span><span style="color:#999999;">;</span></span></code></pre></div><br><br><h3 id="_02-查找所有的依赖模块" tabindex="-1"><code>02</code> 查找所有的依赖模块 <a class="header-anchor" href="#_02-查找所有的依赖模块" aria-label="Permalink to &quot;\`02\` 查找所有的依赖模块&quot;">​</a></h3><blockquote><ul><li>读取代码内容</li><li>读取模块文件相对路径要与 bundle.js 相对应</li><li>读取模块文件中子依赖包，首先需要解析当前模块</li><li>解析结果：解析的源码 sourceCode，以及是否存在子依赖包 dependencies</li><li>代码解析：vue ---&gt; html css js es6 ---&gt; es5</li></ul></blockquote><h4 id="编译器配置文件-compiler-js-1" tabindex="-1">编译器配置文件 Compiler.js <a class="header-anchor" href="#编译器配置文件-compiler-js-1" aria-label="Permalink to &quot;编译器配置文件 Compiler.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fs</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">fs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">path</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// 编译器</span></span>
<span class="line"><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA994;">Compiler</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 入口目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 当前工作目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">process</span><span style="color:#666666;">.</span><span style="color:#80A665;">cwd</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 用来保存所有模块</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 读取模块文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// readFileSync() 同步读取文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fs</span><span style="color:#666666;">.</span><span style="color:#80A665;">readFileSync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">utf-8</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 模块文件解析 source---文件内容， parentPath---文件目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentPath</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log(modulePath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 模块文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">source</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.relative将绝对路径分解成相对路径（返回从第一个路径到第二个路径的相对路径），获取模块名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">relative</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.dirname来获取模块所在相对目录</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 解析结果：解析的源码sourceCode，以及是否存在子依赖包dependencies</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">dirname</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 保存解析的代码</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 递归</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">dependencies</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">((</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 使用path.join来拼接成相对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dep</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 执行方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">run</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.resolve将相对路径拼接成绝对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Compiler</span><span style="color:#666666;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fs</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">fs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">path</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// 编译器</span></span>
<span class="line"><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E8F82;">Compiler</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 入口目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 当前工作目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">process</span><span style="color:#999999;">.</span><span style="color:#59873A;">cwd</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 用来保存所有模块</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 读取模块文件内容</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// readFileSync() 同步读取文件</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fs</span><span style="color:#999999;">.</span><span style="color:#59873A;">readFileSync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">utf-8</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 模块文件解析 source---文件内容， parentPath---文件目录</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentPath</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log(modulePath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 模块文件内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">source</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.relative将绝对路径分解成相对路径（返回从第一个路径到第二个路径的相对路径），获取模块名</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">relative</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.dirname来获取模块所在相对目录</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 解析结果：解析的源码sourceCode，以及是否存在子依赖包dependencies</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">dirname</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 保存解析的代码</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 递归</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">dependencies</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">((</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 使用path.join来拼接成相对路径</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dep</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 执行方法</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">run</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.resolve将相对路径拼接成绝对路径</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Compiler</span><span style="color:#999999;">;</span></span></code></pre></div><br><br><h3 id="_03-模块解析" tabindex="-1"><code>03</code> 模块解析 <a class="header-anchor" href="#_03-模块解析" aria-label="Permalink to &quot;\`03\` 模块解析&quot;">​</a></h3><blockquote><ul><li>使用 AST 语法树解析<a href="https://astexplorer.net/" target="_blank" rel="noreferrer">https://astexplorer.net/</a></li><li>如 const n = 1;---&gt;const x = 1;</li><li>安装包：<code>npm i babylon @babel/traverse @babel/types @babel/generator</code></li><li>将代码中的 require ---&gt; <code>__webpack_require__</code></li><li>将 require( &quot;./jd&quot;) 补全---&gt; require(&quot;./jd.js&quot;)</li><li>收集 dependencies</li></ul></blockquote><h4 id="编译器配置文件-compiler-js-2" tabindex="-1">编译器配置文件 Compiler.js <a class="header-anchor" href="#编译器配置文件-compiler-js-2" aria-label="Permalink to &quot;编译器配置文件 Compiler.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fs</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">fs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">path</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">//  babylon @babel/traverse @babel/types @babel/generator</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">babylon</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">babylon</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">types</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/types</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">// require(&quot;xxx&quot;).default,相当于import xxx from &#39;./xxx&#39;</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">traverse</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/traverse</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">).</span><span style="color:#BD976A;">default</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">generator</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/generator</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">).</span><span style="color:#BD976A;">default</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// 编译器</span></span>
<span class="line"><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA994;">Compiler</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 入口目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 当前工作目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">process</span><span style="color:#666666;">.</span><span style="color:#80A665;">cwd</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 用来保存所有模块</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 读取模块文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// readFileSync() 同步读取文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fs</span><span style="color:#666666;">.</span><span style="color:#80A665;">readFileSync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">utf-8</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 模块文件解析 source---文件内容， parentPath---文件目录</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 解析结果：解析的源码sourceCode，以及是否存在子依赖包dependencies</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentPath</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[];</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//存储子模块依赖</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// const code = &quot;const n =1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用babylon来将源码解析成ast</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ast</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">babylon</span><span style="color:#666666;">.</span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">source</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用traverse来遍历AST节点，当访问者进入一个节点时就会调用enter(进入)方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">traverse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ast</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">CallExpression</span><span style="color:#666666;">(</span><span style="color:#BD976A;">p</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">p</span><span style="color:#666666;">.</span><span style="color:#BD976A;">node</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callee</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">require</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callee</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">__webpack_require__</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 补全拓展名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">arguments</span><span style="color:#666666;">[</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">].</span><span style="color:#BD976A;">value</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 利用path.extname判断模块名是否包含拓展名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">extname</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 使用path.join拼接成相对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#BD976A;">parentPath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">dependencies</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 更新node，将子模块名重写</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">arguments</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">types</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringLiteral</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 如const n = 1;---&gt;const x = 1;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// enter(path){</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">//   if(path.isIdentifier({name:&#39;n&#39;})){</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">//     console.log(path.node);</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">//     path.node.name = &#39;x&#39;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">//   }</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// }</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用generator来将ast解析成源码</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">generator</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ast</span><span style="color:#666666;">).</span><span style="color:#BD976A;">code</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log(modulePath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 模块文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">source</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.relative将绝对路径分解成相对路径（返回从第一个路径到第二个路径的相对路径），获取模块名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">relative</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.dirname来获取模块所在相对目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">dirname</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// // 保存解析的代码</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// this.modules[moduleName] = sourceCode;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// // 递归</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// dependencies.forEach(dep =&gt; {</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">//   // 使用path.join来拼接成相对路径</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">//   this.buildModule(path.join(this.root,dep),false)</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// });</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 执行方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">run</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.resolve将相对路径拼接成绝对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Compiler</span><span style="color:#666666;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fs</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">fs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">path</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">//  babylon @babel/traverse @babel/types @babel/generator</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">babylon</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">babylon</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">types</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/types</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">// require(&quot;xxx&quot;).default,相当于import xxx from &#39;./xxx&#39;</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">traverse</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/traverse</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">).</span><span style="color:#B07D48;">default</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">generator</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/generator</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">).</span><span style="color:#B07D48;">default</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// 编译器</span></span>
<span class="line"><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E8F82;">Compiler</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 入口目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 当前工作目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">process</span><span style="color:#999999;">.</span><span style="color:#59873A;">cwd</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 用来保存所有模块</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 读取模块文件内容</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// readFileSync() 同步读取文件</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fs</span><span style="color:#999999;">.</span><span style="color:#59873A;">readFileSync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">utf-8</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 模块文件解析 source---文件内容， parentPath---文件目录</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 解析结果：解析的源码sourceCode，以及是否存在子依赖包dependencies</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentPath</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[];</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//存储子模块依赖</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// const code = &quot;const n =1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用babylon来将源码解析成ast</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ast</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">babylon</span><span style="color:#999999;">.</span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">source</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用traverse来遍历AST节点，当访问者进入一个节点时就会调用enter(进入)方法</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">traverse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ast</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">CallExpression</span><span style="color:#999999;">(</span><span style="color:#B07D48;">p</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">p</span><span style="color:#999999;">.</span><span style="color:#B07D48;">node</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callee</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">require</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callee</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">__webpack_require__</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 补全拓展名</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">arguments</span><span style="color:#999999;">[</span><span style="color:#2F798A;">0</span><span style="color:#999999;">].</span><span style="color:#B07D48;">value</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 利用path.extname判断模块名是否包含拓展名</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">extname</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 使用path.join拼接成相对路径</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#B07D48;">parentPath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">dependencies</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 更新node，将子模块名重写</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">arguments</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">types</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringLiteral</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)];</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 如const n = 1;---&gt;const x = 1;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// enter(path){</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">//   if(path.isIdentifier({name:&#39;n&#39;})){</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">//     console.log(path.node);</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">//     path.node.name = &#39;x&#39;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">//   }</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// }</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用generator来将ast解析成源码</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">generator</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ast</span><span style="color:#999999;">).</span><span style="color:#B07D48;">code</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log(modulePath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 模块文件内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">source</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.relative将绝对路径分解成相对路径（返回从第一个路径到第二个路径的相对路径），获取模块名</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">relative</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.dirname来获取模块所在相对目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">dirname</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// // 保存解析的代码</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// this.modules[moduleName] = sourceCode;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// // 递归</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// dependencies.forEach(dep =&gt; {</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">//   // 使用path.join来拼接成相对路径</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">//   this.buildModule(path.join(this.root,dep),false)</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// });</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 执行方法</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">run</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.resolve将相对路径拼接成绝对路径</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Compiler</span><span style="color:#999999;">;</span></span></code></pre></div><br><br><h3 id="_04-打包输出" tabindex="-1"><code>04</code> 打包输出 <a class="header-anchor" href="#_04-打包输出" aria-label="Permalink to &quot;\`04\` 打包输出&quot;">​</a></h3><blockquote><ul><li>使用模板生成 bundle.js，传入的参数必须是动态</li><li>模板 express ejs &lt;%=xxx%&gt; <a href="https://ejs.bootcss.com/#install" target="_blank" rel="noreferrer">https://ejs.bootcss.com/#install</a></li><li>使用 fs 将生成的文件写入 bundle.js，使用 index.html 引入打开测试与之前 webpack 打包输出一致</li></ul></blockquote><h4 id="待打包-index-js" tabindex="-1">待打包 index.js <a class="header-anchor" href="#待打包-index-js" aria-label="Permalink to &quot;待打包 index.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">jd</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./jd</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">jd打包工具：</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">jd</span><span style="color:#666666;">);</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">jd</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./jd</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">jd打包工具：</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">jd</span><span style="color:#999999;">);</span></span></code></pre></div><br><h4 id="模版命令文件-bundle-ejs" tabindex="-1">模版命令文件 bundle.ejs <a class="header-anchor" href="#模版命令文件-bundle-ejs" aria-label="Permalink to &quot;模版命令文件 bundle.ejs&quot;">​</a></h4><div class="language-ejs vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ejs</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#dbd7caee;">(() =&gt; { // webpackBootstrap</span></span>
<span class="line"><span style="color:#dbd7caee;">  var __webpack_modules__ = ({</span></span>
<span class="line"><span style="color:#dbd7caee;">    &lt;%for(let key in modules){%&gt;</span></span>
<span class="line"><span style="color:#dbd7caee;">      &quot;&lt;%-key%&gt;&quot;:</span></span>
<span class="line"><span style="color:#dbd7caee;">      ((__unused_webpack_module, __unused_webpack_exports, __webpack_require__) =&gt; {</span></span>
<span class="line"><span style="color:#dbd7caee;">        eval(\`&lt;%-modules[key]%&gt;\`);</span></span>
<span class="line"><span style="color:#dbd7caee;">        }),</span></span>
<span class="line"><span style="color:#dbd7caee;">    &lt;%}%&gt;</span></span>
<span class="line"><span style="color:#dbd7caee;">  });</span></span>
<span class="line"><span style="color:#dbd7caee;"></span></span>
<span class="line"><span style="color:#dbd7caee;">  // The module cache</span></span>
<span class="line"><span style="color:#dbd7caee;">  var __webpack_module_cache__ = {};</span></span>
<span class="line"><span style="color:#dbd7caee;"></span></span>
<span class="line"><span style="color:#dbd7caee;">  // The require function</span></span>
<span class="line"><span style="color:#dbd7caee;">  function __webpack_require__(moduleId) {</span></span>
<span class="line"><span style="color:#dbd7caee;">    // Check if module is in cache</span></span>
<span class="line"><span style="color:#dbd7caee;">    var cachedModule = __webpack_module_cache__[moduleId];</span></span>
<span class="line"><span style="color:#dbd7caee;">    if (cachedModule !== undefined) {</span></span>
<span class="line"><span style="color:#dbd7caee;">      return cachedModule.exports;</span></span>
<span class="line"><span style="color:#dbd7caee;">    }</span></span>
<span class="line"><span style="color:#dbd7caee;">    // Create a new module (and put it into the cache)</span></span>
<span class="line"><span style="color:#dbd7caee;">    var module = __webpack_module_cache__[moduleId] = {</span></span>
<span class="line"><span style="color:#dbd7caee;">      // no module.id needed</span></span>
<span class="line"><span style="color:#dbd7caee;">      // no module.loaded needed</span></span>
<span class="line"><span style="color:#dbd7caee;">      exports: {}</span></span>
<span class="line"><span style="color:#dbd7caee;">    };</span></span>
<span class="line"><span style="color:#dbd7caee;"></span></span>
<span class="line"><span style="color:#dbd7caee;">    // Execute the module function</span></span>
<span class="line"><span style="color:#dbd7caee;">    __webpack_modules__[moduleId](module, module.exports, __webpack_require__);</span></span>
<span class="line"><span style="color:#dbd7caee;"></span></span>
<span class="line"><span style="color:#dbd7caee;">    // Return the exports of the module</span></span>
<span class="line"><span style="color:#dbd7caee;">    return module.exports;</span></span>
<span class="line"><span style="color:#dbd7caee;">  }</span></span>
<span class="line"><span style="color:#dbd7caee;"></span></span>
<span class="line"><span style="color:#dbd7caee;"></span></span>
<span class="line"><span style="color:#dbd7caee;">  var __webpack_exports__ = __webpack_require__(&quot;&lt;%=entryId%&gt;&quot;);</span></span>
<span class="line"><span style="color:#dbd7caee;"></span></span>
<span class="line"><span style="color:#dbd7caee;">})()</span></span>
<span class="line"><span style="color:#dbd7caee;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#393a34;">(() =&gt; { // webpackBootstrap</span></span>
<span class="line"><span style="color:#393a34;">  var __webpack_modules__ = ({</span></span>
<span class="line"><span style="color:#393a34;">    &lt;%for(let key in modules){%&gt;</span></span>
<span class="line"><span style="color:#393a34;">      &quot;&lt;%-key%&gt;&quot;:</span></span>
<span class="line"><span style="color:#393a34;">      ((__unused_webpack_module, __unused_webpack_exports, __webpack_require__) =&gt; {</span></span>
<span class="line"><span style="color:#393a34;">        eval(\`&lt;%-modules[key]%&gt;\`);</span></span>
<span class="line"><span style="color:#393a34;">        }),</span></span>
<span class="line"><span style="color:#393a34;">    &lt;%}%&gt;</span></span>
<span class="line"><span style="color:#393a34;">  });</span></span>
<span class="line"><span style="color:#393a34;"></span></span>
<span class="line"><span style="color:#393a34;">  // The module cache</span></span>
<span class="line"><span style="color:#393a34;">  var __webpack_module_cache__ = {};</span></span>
<span class="line"><span style="color:#393a34;"></span></span>
<span class="line"><span style="color:#393a34;">  // The require function</span></span>
<span class="line"><span style="color:#393a34;">  function __webpack_require__(moduleId) {</span></span>
<span class="line"><span style="color:#393a34;">    // Check if module is in cache</span></span>
<span class="line"><span style="color:#393a34;">    var cachedModule = __webpack_module_cache__[moduleId];</span></span>
<span class="line"><span style="color:#393a34;">    if (cachedModule !== undefined) {</span></span>
<span class="line"><span style="color:#393a34;">      return cachedModule.exports;</span></span>
<span class="line"><span style="color:#393a34;">    }</span></span>
<span class="line"><span style="color:#393a34;">    // Create a new module (and put it into the cache)</span></span>
<span class="line"><span style="color:#393a34;">    var module = __webpack_module_cache__[moduleId] = {</span></span>
<span class="line"><span style="color:#393a34;">      // no module.id needed</span></span>
<span class="line"><span style="color:#393a34;">      // no module.loaded needed</span></span>
<span class="line"><span style="color:#393a34;">      exports: {}</span></span>
<span class="line"><span style="color:#393a34;">    };</span></span>
<span class="line"><span style="color:#393a34;"></span></span>
<span class="line"><span style="color:#393a34;">    // Execute the module function</span></span>
<span class="line"><span style="color:#393a34;">    __webpack_modules__[moduleId](module, module.exports, __webpack_require__);</span></span>
<span class="line"><span style="color:#393a34;"></span></span>
<span class="line"><span style="color:#393a34;">    // Return the exports of the module</span></span>
<span class="line"><span style="color:#393a34;">    return module.exports;</span></span>
<span class="line"><span style="color:#393a34;">  }</span></span>
<span class="line"><span style="color:#393a34;"></span></span>
<span class="line"><span style="color:#393a34;"></span></span>
<span class="line"><span style="color:#393a34;">  var __webpack_exports__ = __webpack_require__(&quot;&lt;%=entryId%&gt;&quot;);</span></span>
<span class="line"><span style="color:#393a34;"></span></span>
<span class="line"><span style="color:#393a34;">})()</span></span>
<span class="line"><span style="color:#393a34;">;</span></span></code></pre></div><h4 id="编译器配置文件-compiler-js-3" tabindex="-1">编译器配置文件 Compiler.js <a class="header-anchor" href="#编译器配置文件-compiler-js-3" aria-label="Permalink to &quot;编译器配置文件 Compiler.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fs</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">fs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">path</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">//  babylon @babel/traverse @babel/types @babel/generator</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">babylon</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">babylon</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">types</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/types</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">// require(&quot;xxx&quot;).default,相当于import xxx from &#39;./xxx&#39;</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">traverse</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/traverse</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">).</span><span style="color:#BD976A;">default</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">generator</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/generator</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">).</span><span style="color:#BD976A;">default</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#758575DD;">// 模版引擎</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ejs</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">ejs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// 编译器</span></span>
<span class="line"><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA994;">Compiler</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 入口目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 当前工作目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">process</span><span style="color:#666666;">.</span><span style="color:#80A665;">cwd</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 用来保存所有模块</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 读取模块文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// readFileSync() 同步读取文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fs</span><span style="color:#666666;">.</span><span style="color:#80A665;">readFileSync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">utf-8</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 模块文件解析 source---文件内容， parentPath---文件目录</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 解析结果：解析的源码sourceCode，以及是否存在子依赖包dependencies</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentPath</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[];</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//存储子模块依赖</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// const code = &quot;const n =1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用babylon来将源码解析成ast</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ast</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">babylon</span><span style="color:#666666;">.</span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">source</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用traverse来遍历AST节点，当访问者进入一个节点时就会调用enter(进入)方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">traverse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ast</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">CallExpression</span><span style="color:#666666;">(</span><span style="color:#BD976A;">p</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">p</span><span style="color:#666666;">.</span><span style="color:#BD976A;">node</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callee</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">require</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callee</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">__webpack_require__</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 补全拓展名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">arguments</span><span style="color:#666666;">[</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">].</span><span style="color:#BD976A;">value</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 利用path.extname判断模块名是否包含拓展名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">extname</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 使用path.join拼接成相对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#BD976A;">parentPath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">dependencies</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 更新node，将子模块名重写</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">arguments</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">types</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringLiteral</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 如const n = 1;---&gt;const x = 1;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// enter(path){</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">//   if(path.isIdentifier({name:&#39;n&#39;})){</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">//     console.log(path.node);</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">//     path.node.name = &#39;x&#39;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">//   }</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// }</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用generator来将ast解析成源码</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">generator</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ast</span><span style="color:#666666;">).</span><span style="color:#BD976A;">code</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log(sourceCode);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log(modulePath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 模块文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">source</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.relative将绝对路径分解成相对路径（返回从第一个路径到第二个路径的相对路径），获取模块名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">relative</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.dirname来获取模块所在相对目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">dirname</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 保存解析的代码</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 递归</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">dependencies</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">((</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 使用path.join来拼接成相对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dep</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 生成打包文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">emitFile</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 打包路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">main</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">output</span><span style="color:#666666;">.</span><span style="color:#BD976A;">path</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">output</span><span style="color:#666666;">.</span><span style="color:#BD976A;">filename</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取模版内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">templateStr</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">bundle.ejs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">));</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 调用模版生成</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">result</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ejs</span><span style="color:#666666;">.</span><span style="color:#80A665;">render</span><span style="color:#666666;">(</span><span style="color:#BD976A;">templateStr</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">entryId</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">modules</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 定义打包文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">assets</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">assets</span><span style="color:#666666;">[</span><span style="color:#BD976A;">main</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">result</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//文件全名---文件内容</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 输出打包文件</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log(main);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log( this.assets);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">fs</span><span style="color:#666666;">.</span><span style="color:#80A665;">writeFileSync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">main</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">assets</span><span style="color:#666666;">[</span><span style="color:#BD976A;">main</span><span style="color:#666666;">]);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 执行方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">run</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.resolve将相对路径拼接成绝对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">emitFile</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Compiler</span><span style="color:#666666;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fs</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">fs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">path</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">//  babylon @babel/traverse @babel/types @babel/generator</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">babylon</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">babylon</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">types</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/types</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">// require(&quot;xxx&quot;).default,相当于import xxx from &#39;./xxx&#39;</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">traverse</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/traverse</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">).</span><span style="color:#B07D48;">default</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">generator</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/generator</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">).</span><span style="color:#B07D48;">default</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#A0ADA0;">// 模版引擎</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ejs</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">ejs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// 编译器</span></span>
<span class="line"><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E8F82;">Compiler</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 入口目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 当前工作目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">process</span><span style="color:#999999;">.</span><span style="color:#59873A;">cwd</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 用来保存所有模块</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 读取模块文件内容</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// readFileSync() 同步读取文件</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fs</span><span style="color:#999999;">.</span><span style="color:#59873A;">readFileSync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">utf-8</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 模块文件解析 source---文件内容， parentPath---文件目录</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 解析结果：解析的源码sourceCode，以及是否存在子依赖包dependencies</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentPath</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[];</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//存储子模块依赖</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// const code = &quot;const n =1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用babylon来将源码解析成ast</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ast</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">babylon</span><span style="color:#999999;">.</span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">source</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用traverse来遍历AST节点，当访问者进入一个节点时就会调用enter(进入)方法</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">traverse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ast</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">CallExpression</span><span style="color:#999999;">(</span><span style="color:#B07D48;">p</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">p</span><span style="color:#999999;">.</span><span style="color:#B07D48;">node</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callee</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">require</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callee</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">__webpack_require__</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 补全拓展名</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">arguments</span><span style="color:#999999;">[</span><span style="color:#2F798A;">0</span><span style="color:#999999;">].</span><span style="color:#B07D48;">value</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 利用path.extname判断模块名是否包含拓展名</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">extname</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 使用path.join拼接成相对路径</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#B07D48;">parentPath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">dependencies</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 更新node，将子模块名重写</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">arguments</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">types</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringLiteral</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)];</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 如const n = 1;---&gt;const x = 1;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// enter(path){</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">//   if(path.isIdentifier({name:&#39;n&#39;})){</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">//     console.log(path.node);</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">//     path.node.name = &#39;x&#39;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">//   }</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// }</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用generator来将ast解析成源码</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">generator</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ast</span><span style="color:#999999;">).</span><span style="color:#B07D48;">code</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log(sourceCode);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log(modulePath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 模块文件内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">source</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.relative将绝对路径分解成相对路径（返回从第一个路径到第二个路径的相对路径），获取模块名</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">relative</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.dirname来获取模块所在相对目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">dirname</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 保存解析的代码</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 递归</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">dependencies</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">((</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 使用path.join来拼接成相对路径</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dep</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 生成打包文件</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">emitFile</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 打包路径</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">main</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">output</span><span style="color:#999999;">.</span><span style="color:#B07D48;">path</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">output</span><span style="color:#999999;">.</span><span style="color:#B07D48;">filename</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取模版内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">templateStr</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">bundle.ejs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">));</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 调用模版生成</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">result</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ejs</span><span style="color:#999999;">.</span><span style="color:#59873A;">render</span><span style="color:#999999;">(</span><span style="color:#B07D48;">templateStr</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">entryId</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">modules</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 定义打包文件内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">assets</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">assets</span><span style="color:#999999;">[</span><span style="color:#B07D48;">main</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">result</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//文件全名---文件内容</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 输出打包文件</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log(main);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log( this.assets);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">fs</span><span style="color:#999999;">.</span><span style="color:#59873A;">writeFileSync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">main</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">assets</span><span style="color:#999999;">[</span><span style="color:#B07D48;">main</span><span style="color:#999999;">]);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 执行方法</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">run</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.resolve将相对路径拼接成绝对路径</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">emitFile</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Compiler</span><span style="color:#999999;">;</span></span></code></pre></div><h4 id="生成的-bundle-js" tabindex="-1">生成的 bundle.js <a class="header-anchor" href="#生成的-bundle-js" aria-label="Permalink to &quot;生成的 bundle.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// webpackBootstrap</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_modules__</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./srcindex.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_module</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_exports</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__webpack_require__</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">eval</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">\`</span><span style="color:#C98A7D;">let jd = __webpack_require__(&quot;./src</span><span style="color:#C99076;">\\\\</span><span style="color:#C98A7D;">jd.js&quot;);</span></span>
<span class="line"><span style="color:#C98A7D;">console.log(&quot;jd打包工具：&quot; + jd);</span><span style="color:#C98A7D99;">\`</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./srcjd.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_module</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_exports</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__webpack_require__</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">eval</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">\`</span><span style="color:#C98A7D;">let name = &quot;自定义打包工具&quot;;</span></span>
<span class="line"><span style="color:#C98A7D;">module.exports = name;</span><span style="color:#C98A7D99;">\`</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// The module cache</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_module_cache__</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// The require function</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">__webpack_require__</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Check if module is in cache</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">cachedModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_module_cache__</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">cachedModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">cachedModule</span><span style="color:#666666;">.</span><span style="color:#BD976A;">exports</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Create a new module (and put it into the cache)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">module</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">__webpack_module_cache__</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// no module.id needed</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// no module.loaded needed</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">exports</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Execute the module function</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">__webpack_modules__</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">](</span><span style="color:#B8A965;">module</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_require__</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Return the exports of the module</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_exports__</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">__webpack_require__</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./srcindex.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">})();</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// webpackBootstrap</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_modules__</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./srcindex.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_module</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_exports</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__webpack_require__</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">eval</span><span style="color:#999999;">(</span><span style="color:#B5695999;">\`</span><span style="color:#B56959;">let jd = __webpack_require__(&quot;./src</span><span style="color:#A65E2B;">\\\\</span><span style="color:#B56959;">jd.js&quot;);</span></span>
<span class="line"><span style="color:#B56959;">console.log(&quot;jd打包工具：&quot; + jd);</span><span style="color:#B5695999;">\`</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./srcjd.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_module</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_exports</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__webpack_require__</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">eval</span><span style="color:#999999;">(</span><span style="color:#B5695999;">\`</span><span style="color:#B56959;">let name = &quot;自定义打包工具&quot;;</span></span>
<span class="line"><span style="color:#B56959;">module.exports = name;</span><span style="color:#B5695999;">\`</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// The module cache</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_module_cache__</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// The require function</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">__webpack_require__</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Check if module is in cache</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">cachedModule</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_module_cache__</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">cachedModule</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">cachedModule</span><span style="color:#999999;">.</span><span style="color:#B07D48;">exports</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Create a new module (and put it into the cache)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">module</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">__webpack_module_cache__</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// no module.id needed</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// no module.loaded needed</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">exports</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{},</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Execute the module function</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">__webpack_modules__</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">](</span><span style="color:#998418;">module</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_require__</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Return the exports of the module</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_exports__</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">__webpack_require__</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./srcindex.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">})();</span></span></code></pre></div><br><h4 id="html-引入-bundle-js-运行结果" tabindex="-1">HTML 引入 bundle.js 运行结果 <a class="header-anchor" href="#html-引入-bundle-js-运行结果" aria-label="Permalink to &quot;HTML 引入 bundle.js 运行结果&quot;">​</a></h4><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151859952.png" alt="image-20230724002540146"></p><br><br><h3 id="_05-手写-loader-加载器" tabindex="-1"><code>05</code> 手写 loader（加载器） <a class="header-anchor" href="#_05-手写-loader-加载器" aria-label="Permalink to &quot;\`05\` 手写 loader（加载器）&quot;">​</a></h3><blockquote><ul><li>作用:转化，less ---&gt; css、vue--&gt;js html css</li><li>使用 npx webpack 打包 less</li><li>使用自定义的 loader，如 less-loader style-loader</li><li>打包时必须使用自定义 loader</li></ul></blockquote><h4 id="待打包-index-js-1" tabindex="-1">待打包 index.js <a class="header-anchor" href="#待打包-index-js-1" aria-label="Permalink to &quot;待打包 index.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">jd</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./jd</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./style.less</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">jd打包工具：</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">jd</span><span style="color:#666666;">);</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">jd</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./jd</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./style.less</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">jd打包工具：</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">jd</span><span style="color:#999999;">);</span></span></code></pre></div><br><h4 id="编译器配置文件-compiler-js-4" tabindex="-1">编译器配置文件 Compiler.js <a class="header-anchor" href="#编译器配置文件-compiler-js-4" aria-label="Permalink to &quot;编译器配置文件 Compiler.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fs</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">fs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">path</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">//  babylon @babel/traverse @babel/types @babel/generator</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">babylon</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">babylon</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">types</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/types</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">// require(&quot;xxx&quot;).default,相当于import xxx from &#39;./xxx&#39;</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">traverse</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/traverse</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">).</span><span style="color:#BD976A;">default</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">generator</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/generator</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">).</span><span style="color:#BD976A;">default</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#758575DD;">// 模版引擎</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ejs</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">ejs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// 编译器</span></span>
<span class="line"><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA994;">Compiler</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 入口目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 当前工作目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">process</span><span style="color:#666666;">.</span><span style="color:#80A665;">cwd</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 用来保存所有模块</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 读取模块文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rules</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">module</span><span style="color:#666666;">.</span><span style="color:#BD976A;">rules</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// readFileSync() 同步读取文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">content</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fs</span><span style="color:#666666;">.</span><span style="color:#80A665;">readFileSync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">utf-8</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">&lt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rules</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#CB7676;">++</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rules</span><span style="color:#666666;">[</span><span style="color:#BD976A;">i</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">test</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">use</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rule</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">len</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">use</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">-</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">1</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//loader的总长度-1</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 判断是否为less文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">test</span><span style="color:#666666;">.</span><span style="color:#80A665;">test</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">normalLoader</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">loader</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#BD976A;">use</span><span style="color:#666666;">[</span><span style="color:#BD976A;">len</span><span style="color:#CB7676;">--</span><span style="color:#666666;">]);</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//从右到左，从下到上</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 进行转换</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">content</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">loader</span><span style="color:#666666;">(</span><span style="color:#BD976A;">content</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 递归遍历所有的loader</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">len</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">&gt;=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">normalLoader</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">normalLoader</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">content</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 模块文件解析 source---文件内容， parentPath---文件目录</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 解析结果：解析的源码sourceCode，以及是否存在子依赖包dependencies</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentPath</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[];</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//存储子模块依赖</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// const code = &quot;const n =1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用babylon来将源码解析成ast</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ast</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">babylon</span><span style="color:#666666;">.</span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">source</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用traverse来遍历AST节点，当访问者进入一个节点时就会调用​enter(进入)​​​方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">traverse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ast</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">CallExpression</span><span style="color:#666666;">(</span><span style="color:#BD976A;">p</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">p</span><span style="color:#666666;">.</span><span style="color:#BD976A;">node</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callee</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">require</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callee</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">__webpack_require__</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 补全拓展名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">arguments</span><span style="color:#666666;">[</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">].</span><span style="color:#BD976A;">value</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 利用path.extname判断模块名是否包含拓展名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">extname</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 使用path.join拼接成相对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#BD976A;">parentPath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">dependencies</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 更新node，将子模块名重写</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">arguments</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">types</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringLiteral</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用generator来将ast解析成源码</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">generator</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ast</span><span style="color:#666666;">).</span><span style="color:#BD976A;">code</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log(modulePath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 模块文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">source</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.relative将绝对路径分解成相对路径（返回从第一个路径到第二个路径的相对路径），获取模块名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">relative</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.dirname来获取模块所在相对目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">dirname</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 保存解析的代码</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 递归</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">dependencies</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">((</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 使用path.join来拼接成相对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dep</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 生成打包文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">emitFile</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 打包路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">main</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">output</span><span style="color:#666666;">.</span><span style="color:#BD976A;">path</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">output</span><span style="color:#666666;">.</span><span style="color:#BD976A;">filename</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取模版内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">templateStr</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">bundle.ejs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">));</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 调用模版生成</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">result</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ejs</span><span style="color:#666666;">.</span><span style="color:#80A665;">render</span><span style="color:#666666;">(</span><span style="color:#BD976A;">templateStr</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">entryId</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">modules</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 定义打包文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">assets</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">assets</span><span style="color:#666666;">[</span><span style="color:#BD976A;">main</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">result</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//文件全名---文件内容</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 输出打包文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">fs</span><span style="color:#666666;">.</span><span style="color:#80A665;">writeFileSync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">main</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">assets</span><span style="color:#666666;">[</span><span style="color:#BD976A;">main</span><span style="color:#666666;">]);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 执行方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">run</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.resolve将相对路径拼接成绝对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">emitFile</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Compiler</span><span style="color:#666666;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fs</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">fs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">path</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">//  babylon @babel/traverse @babel/types @babel/generator</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">babylon</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">babylon</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">types</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/types</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">// require(&quot;xxx&quot;).default,相当于import xxx from &#39;./xxx&#39;</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">traverse</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/traverse</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">).</span><span style="color:#B07D48;">default</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">generator</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/generator</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">).</span><span style="color:#B07D48;">default</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#A0ADA0;">// 模版引擎</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ejs</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">ejs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// 编译器</span></span>
<span class="line"><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E8F82;">Compiler</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 入口目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 当前工作目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">process</span><span style="color:#999999;">.</span><span style="color:#59873A;">cwd</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 用来保存所有模块</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 读取模块文件内容</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rules</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">module</span><span style="color:#999999;">.</span><span style="color:#B07D48;">rules</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// readFileSync() 同步读取文件</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">content</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fs</span><span style="color:#999999;">.</span><span style="color:#59873A;">readFileSync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">utf-8</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">for</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#393A34;"> </span><span style="color:#999999;">&lt;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rules</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#AB5959;">++</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rule</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rules</span><span style="color:#999999;">[</span><span style="color:#B07D48;">i</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">test</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">use</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rule</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">len</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">use</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">-</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">1</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//loader的总长度-1</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 判断是否为less文件</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">test</span><span style="color:#999999;">.</span><span style="color:#59873A;">test</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">normalLoader</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">loader</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B07D48;">use</span><span style="color:#999999;">[</span><span style="color:#B07D48;">len</span><span style="color:#AB5959;">--</span><span style="color:#999999;">]);</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//从右到左，从下到上</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 进行转换</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">content</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">loader</span><span style="color:#999999;">(</span><span style="color:#B07D48;">content</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 递归遍历所有的loader</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">len</span><span style="color:#393A34;"> </span><span style="color:#999999;">&gt;=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">normalLoader</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">normalLoader</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">content</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 模块文件解析 source---文件内容， parentPath---文件目录</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 解析结果：解析的源码sourceCode，以及是否存在子依赖包dependencies</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentPath</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[];</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//存储子模块依赖</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// const code = &quot;const n =1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用babylon来将源码解析成ast</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ast</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">babylon</span><span style="color:#999999;">.</span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">source</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用traverse来遍历AST节点，当访问者进入一个节点时就会调用​enter(进入)​​​方法</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">traverse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ast</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">CallExpression</span><span style="color:#999999;">(</span><span style="color:#B07D48;">p</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">p</span><span style="color:#999999;">.</span><span style="color:#B07D48;">node</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callee</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">require</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callee</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">__webpack_require__</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 补全拓展名</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">arguments</span><span style="color:#999999;">[</span><span style="color:#2F798A;">0</span><span style="color:#999999;">].</span><span style="color:#B07D48;">value</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 利用path.extname判断模块名是否包含拓展名</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">extname</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 使用path.join拼接成相对路径</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#B07D48;">parentPath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">dependencies</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 更新node，将子模块名重写</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">arguments</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">types</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringLiteral</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)];</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用generator来将ast解析成源码</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">generator</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ast</span><span style="color:#999999;">).</span><span style="color:#B07D48;">code</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log(modulePath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 模块文件内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">source</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.relative将绝对路径分解成相对路径（返回从第一个路径到第二个路径的相对路径），获取模块名</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">relative</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.dirname来获取模块所在相对目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">dirname</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 保存解析的代码</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 递归</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">dependencies</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">((</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 使用path.join来拼接成相对路径</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dep</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 生成打包文件</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">emitFile</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 打包路径</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">main</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">output</span><span style="color:#999999;">.</span><span style="color:#B07D48;">path</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">output</span><span style="color:#999999;">.</span><span style="color:#B07D48;">filename</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取模版内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">templateStr</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">bundle.ejs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">));</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 调用模版生成</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">result</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ejs</span><span style="color:#999999;">.</span><span style="color:#59873A;">render</span><span style="color:#999999;">(</span><span style="color:#B07D48;">templateStr</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">entryId</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">modules</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 定义打包文件内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">assets</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">assets</span><span style="color:#999999;">[</span><span style="color:#B07D48;">main</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">result</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//文件全名---文件内容</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 输出打包文件</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">fs</span><span style="color:#999999;">.</span><span style="color:#59873A;">writeFileSync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">main</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">assets</span><span style="color:#999999;">[</span><span style="color:#B07D48;">main</span><span style="color:#999999;">]);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 执行方法</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">run</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.resolve将相对路径拼接成绝对路径</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">emitFile</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Compiler</span><span style="color:#999999;">;</span></span></code></pre></div><br><h4 id="自定义-less-loader-js" tabindex="-1">自定义 less-loader.js <a class="header-anchor" href="#自定义-less-loader-js" aria-label="Permalink to &quot;自定义 less-loader.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">less</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">less</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">loader</span><span style="color:#666666;">(</span><span style="color:#BD976A;">sourceLess</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">css</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">less</span><span style="color:#666666;">.</span><span style="color:#80A665;">render</span><span style="color:#666666;">(</span><span style="color:#BD976A;">sourceLess</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">err</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">res</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">css</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">res</span><span style="color:#666666;">.</span><span style="color:#BD976A;">css</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 将\\n改为\\\\n</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">css</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">css</span><span style="color:#666666;">.</span><span style="color:#80A665;">replace</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">/</span><span style="color:#C99076;">\\n</span><span style="color:#C98A7D99;">/</span><span style="color:#4D9375;">g</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C99076;">\\\\</span><span style="color:#C98A7D;">n</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">css</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">loader</span><span style="color:#666666;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">less</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">less</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">loader</span><span style="color:#999999;">(</span><span style="color:#B07D48;">sourceLess</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">css</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">less</span><span style="color:#999999;">.</span><span style="color:#59873A;">render</span><span style="color:#999999;">(</span><span style="color:#B07D48;">sourceLess</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">err</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">res</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">css</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">res</span><span style="color:#999999;">.</span><span style="color:#B07D48;">css</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 将\\n改为\\\\n</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">css</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">css</span><span style="color:#999999;">.</span><span style="color:#59873A;">replace</span><span style="color:#999999;">(</span><span style="color:#B5695999;">/</span><span style="color:#A65E2B;">\\n</span><span style="color:#B5695999;">/</span><span style="color:#1E754F;">g</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#A65E2B;">\\\\</span><span style="color:#B56959;">n</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">css</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">loader</span><span style="color:#999999;">;</span></span></code></pre></div><br><h4 id="自定义-style-loader-js" tabindex="-1">自定义 style-loader.js <a class="header-anchor" href="#自定义-style-loader-js" aria-label="Permalink to &quot;自定义 style-loader.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">loader</span><span style="color:#666666;">(</span><span style="color:#BD976A;">sourceCss</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">style</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">\`</span></span>
<span class="line"><span style="color:#C98A7D;">    let  style = document.createElement(&#39;style&#39;);</span></span>
<span class="line"><span style="color:#C98A7D;">    style.innerHTML = </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">JSON</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringify</span><span style="color:#666666;">(</span><span style="color:#C98A7D;">sourceCss</span><span style="color:#666666;">)</span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#C98A7D;">    document.head.appendChild(style)</span></span>
<span class="line"><span style="color:#C98A7D;">  </span><span style="color:#C98A7D99;">\`</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">style</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">loader</span><span style="color:#666666;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">loader</span><span style="color:#999999;">(</span><span style="color:#B07D48;">sourceCss</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">style</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">\`</span></span>
<span class="line"><span style="color:#B56959;">    let  style = document.createElement(&#39;style&#39;);</span></span>
<span class="line"><span style="color:#B56959;">    style.innerHTML = </span><span style="color:#999999;">\${</span><span style="color:#B56959;">JSON</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringify</span><span style="color:#999999;">(</span><span style="color:#B56959;">sourceCss</span><span style="color:#999999;">)</span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#B56959;">    document.head.appendChild(style)</span></span>
<span class="line"><span style="color:#B56959;">  </span><span style="color:#B5695999;">\`</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">style</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">loader</span><span style="color:#999999;">;</span></span></code></pre></div><br><h4 id="生成的-bundle-js-1" tabindex="-1">生成的 bundle.js <a class="header-anchor" href="#生成的-bundle-js-1" aria-label="Permalink to &quot;生成的 bundle.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// webpackBootstrap</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_modules__</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./srcindex.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_module</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_exports</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__webpack_require__</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">eval</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">\`</span><span style="color:#C98A7D;">let jd = __webpack_require__(&quot;./src</span><span style="color:#C99076;">\\\\</span><span style="color:#C98A7D;">jd.js&quot;);</span></span>
<span class="line"><span style="color:#C98A7D;">__webpack_require__(&quot;./src</span><span style="color:#C99076;">\\\\</span><span style="color:#C98A7D;">style.less&quot;);</span></span>
<span class="line"><span style="color:#C98A7D;">console.log(&quot;jd打包工具：&quot; + jd);</span><span style="color:#C98A7D99;">\`</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./srcjd.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_module</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_exports</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__webpack_require__</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">eval</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">\`</span><span style="color:#C98A7D;">let name = &quot;自定义打包工具&quot;;</span></span>
<span class="line"><span style="color:#C98A7D;">module.exports = name;</span><span style="color:#C98A7D99;">\`</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./srcstyle.less</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_module</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__unused_webpack_exports</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">__webpack_require__</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">eval</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">\`</span><span style="color:#C98A7D;">let style = document.createElement(&#39;style&#39;);</span></span>
<span class="line"><span style="color:#C98A7D;">style.innerHTML = &quot;body {</span><span style="color:#C99076;">\\\\</span><span style="color:#C98A7D;">n  background: red;</span><span style="color:#C99076;">\\\\</span><span style="color:#C98A7D;">n}</span><span style="color:#C99076;">\\\\</span><span style="color:#C98A7D;">n&quot;;</span></span>
<span class="line"><span style="color:#C98A7D;">document.head.appendChild(style);</span><span style="color:#C98A7D99;">\`</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// The module cache</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_module_cache__</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// The require function</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">__webpack_require__</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Check if module is in cache</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">cachedModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_module_cache__</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">cachedModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">cachedModule</span><span style="color:#666666;">.</span><span style="color:#BD976A;">exports</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Create a new module (and put it into the cache)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">module</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">__webpack_module_cache__</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// no module.id needed</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// no module.loaded needed</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">exports</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Execute the module function</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">__webpack_modules__</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleId</span><span style="color:#666666;">](</span><span style="color:#B8A965;">module</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_require__</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Return the exports of the module</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">var</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">__webpack_exports__</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">__webpack_require__</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./srcindex.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">})();</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// webpackBootstrap</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_modules__</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./srcindex.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_module</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_exports</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__webpack_require__</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">eval</span><span style="color:#999999;">(</span><span style="color:#B5695999;">\`</span><span style="color:#B56959;">let jd = __webpack_require__(&quot;./src</span><span style="color:#A65E2B;">\\\\</span><span style="color:#B56959;">jd.js&quot;);</span></span>
<span class="line"><span style="color:#B56959;">__webpack_require__(&quot;./src</span><span style="color:#A65E2B;">\\\\</span><span style="color:#B56959;">style.less&quot;);</span></span>
<span class="line"><span style="color:#B56959;">console.log(&quot;jd打包工具：&quot; + jd);</span><span style="color:#B5695999;">\`</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./srcjd.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_module</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_exports</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__webpack_require__</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">eval</span><span style="color:#999999;">(</span><span style="color:#B5695999;">\`</span><span style="color:#B56959;">let name = &quot;自定义打包工具&quot;;</span></span>
<span class="line"><span style="color:#B56959;">module.exports = name;</span><span style="color:#B5695999;">\`</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./srcstyle.less</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_module</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__unused_webpack_exports</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">__webpack_require__</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">eval</span><span style="color:#999999;">(</span><span style="color:#B5695999;">\`</span><span style="color:#B56959;">let style = document.createElement(&#39;style&#39;);</span></span>
<span class="line"><span style="color:#B56959;">style.innerHTML = &quot;body {</span><span style="color:#A65E2B;">\\\\</span><span style="color:#B56959;">n  background: red;</span><span style="color:#A65E2B;">\\\\</span><span style="color:#B56959;">n}</span><span style="color:#A65E2B;">\\\\</span><span style="color:#B56959;">n&quot;;</span></span>
<span class="line"><span style="color:#B56959;">document.head.appendChild(style);</span><span style="color:#B5695999;">\`</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// The module cache</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_module_cache__</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// The require function</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">__webpack_require__</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Check if module is in cache</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">cachedModule</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_module_cache__</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">cachedModule</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">cachedModule</span><span style="color:#999999;">.</span><span style="color:#B07D48;">exports</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Create a new module (and put it into the cache)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">module</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">__webpack_module_cache__</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// no module.id needed</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// no module.loaded needed</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">exports</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{},</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Execute the module function</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">__webpack_modules__</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleId</span><span style="color:#999999;">](</span><span style="color:#998418;">module</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_require__</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Return the exports of the module</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">var</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">__webpack_exports__</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">__webpack_require__</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./srcindex.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">})();</span></span></code></pre></div><br><h4 id="html-引入-bundle-js-运行结果-1" tabindex="-1">HTML 引入 bundle.js 运行结果 <a class="header-anchor" href="#html-引入-bundle-js-运行结果-1" aria-label="Permalink to &quot;HTML 引入 bundle.js 运行结果&quot;">​</a></h4><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900174.png" alt="image-20230725005816186"></p><br><br><h3 id="_06-手写-plugin-插件" tabindex="-1"><code>06</code> 手写 plugin（插件） <a class="header-anchor" href="#_06-手写-plugin-插件" aria-label="Permalink to &quot;\`06\` 手写 plugin（插件）&quot;">​</a></h3><blockquote><ul><li>代码加工:压缩，合并，混淆</li><li>tapable 插件 ---&gt; 发布订阅处理 plugin 的事件流程</li><li>需要一个固定的 apply 方法，会在编译器中调用</li></ul></blockquote><h4 id="自定义-myplugin-js" tabindex="-1">自定义 myPlugin.js <a class="header-anchor" href="#自定义-myplugin-js" aria-label="Permalink to &quot;自定义 myPlugin.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA994;">MyPlugin</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 处理源码</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 调用</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">apply</span><span style="color:#666666;">(</span><span style="color:#BD976A;">compiler</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">strat</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 注册订阅</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">compiler</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hooks</span><span style="color:#666666;">.</span><span style="color:#BD976A;">emit</span><span style="color:#666666;">.</span><span style="color:#80A665;">tap</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">emit</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">emit</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">compiler</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hooks</span><span style="color:#666666;">.</span><span style="color:#BD976A;">emit</span><span style="color:#666666;">.</span><span style="color:#80A665;">tap</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">done</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">done</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">MyPlugin</span><span style="color:#666666;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E8F82;">MyPlugin</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 处理源码</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 调用</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">apply</span><span style="color:#999999;">(</span><span style="color:#B07D48;">compiler</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">strat</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 注册订阅</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">compiler</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hooks</span><span style="color:#999999;">.</span><span style="color:#B07D48;">emit</span><span style="color:#999999;">.</span><span style="color:#59873A;">tap</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">emit</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">emit</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">compiler</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hooks</span><span style="color:#999999;">.</span><span style="color:#B07D48;">emit</span><span style="color:#999999;">.</span><span style="color:#59873A;">tap</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">done</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">done</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">MyPlugin</span><span style="color:#999999;">;</span></span></code></pre></div><br><h4 id="配置文件-webpack-config-js" tabindex="-1">配置文件 webpack.config.js <a class="header-anchor" href="#配置文件-webpack-config-js" aria-label="Permalink to &quot;配置文件 webpack.config.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">path</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">MyPlugin</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./plugin/myPlugin</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">mode</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">development</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//开发模式</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">entry</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./src/index.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//打包入口</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">output</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">filename</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">bundle.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//打包输出的文件名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">path</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">dist</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//打包输出的目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">module</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">rules</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">test</span><span style="color:#666666;">:</span><span style="color:#C4704F;"> </span><span style="color:#C98A7D99;">/</span><span style="color:#E6CC77;">\\.</span><span style="color:#C4704F;">less</span><span style="color:#4D9375;">$</span><span style="color:#C98A7D99;">/</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">use</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 从上到下</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">loader</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">style-loader</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">loader</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">less-loader</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">plugins</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">MyPlugin</span><span style="color:#666666;">()],</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#666666;">};</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">path</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">MyPlugin</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./plugin/myPlugin</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">mode</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">development</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//开发模式</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">entry</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./src/index.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//打包入口</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">output</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">filename</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">bundle.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//打包输出的文件名</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">path</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">dist</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//打包输出的目录</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">module</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">rules</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">test</span><span style="color:#999999;">:</span><span style="color:#AB5E3F;"> </span><span style="color:#B5695999;">/</span><span style="color:#BDA437;">\\.</span><span style="color:#AB5E3F;">less</span><span style="color:#1E754F;">$</span><span style="color:#B5695999;">/</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">use</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 从上到下</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">loader</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">style-loader</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">),</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">loader</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">less-loader</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">),</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">plugins</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">MyPlugin</span><span style="color:#999999;">()],</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#999999;">};</span></span></code></pre></div><br><h4 id="编译器配置文件-compiler-js-5" tabindex="-1">编译器配置文件 Compiler.js <a class="header-anchor" href="#编译器配置文件-compiler-js-5" aria-label="Permalink to &quot;编译器配置文件 Compiler.js&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fs</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">fs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">path</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">//  babylon @babel/traverse @babel/types @babel/generator</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">babylon</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">babylon</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">types</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/types</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">// require(&quot;xxx&quot;).default,相当于import xxx from &#39;./xxx&#39;</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">traverse</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/traverse</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">).</span><span style="color:#BD976A;">default</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">generator</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">@babel/generator</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">).</span><span style="color:#BD976A;">default</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#758575DD;">// 模版引擎</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ejs</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">ejs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">// 发布者订阅模式钩子，观察者</span></span>
<span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">SyncHook</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">tapable</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">emit</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">process</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// 编译器</span></span>
<span class="line"><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA994;">Compiler</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 入口目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 当前工作目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">process</span><span style="color:#666666;">.</span><span style="color:#80A665;">cwd</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 用来保存所有模块</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 钩子</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hooks</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">entryOption</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">SyncHook</span><span style="color:#666666;">(),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//开始</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">compile</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">SyncHook</span><span style="color:#666666;">(),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//编译</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">afterCompile</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">SyncHook</span><span style="color:#666666;">(),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//编译后</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">run</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">SyncHook</span><span style="color:#666666;">(),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//编译后</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">emit</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">SyncHook</span><span style="color:#666666;">(),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//发送</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">done</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">SyncHook</span><span style="color:#666666;">(),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//完成</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">plugin</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">module</span><span style="color:#666666;">.</span><span style="color:#BD976A;">plugins</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">Array</span><span style="color:#666666;">.</span><span style="color:#80A665;">isArray</span><span style="color:#666666;">(</span><span style="color:#BD976A;">plugin</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">plugin</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">((</span><span style="color:#BD976A;">p</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">p</span><span style="color:#666666;">.</span><span style="color:#80A665;">apply</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 读取模块文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rules</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">module</span><span style="color:#666666;">.</span><span style="color:#BD976A;">rules</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// readFileSync() 同步读取文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">content</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fs</span><span style="color:#666666;">.</span><span style="color:#80A665;">readFileSync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">utf-8</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">&lt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rules</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#CB7676;">++</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rules</span><span style="color:#666666;">[</span><span style="color:#BD976A;">i</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">test</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">use</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rule</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">len</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">use</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">-</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">1</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//loader的总长度-1</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 判断是否为less文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">test</span><span style="color:#666666;">.</span><span style="color:#80A665;">test</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">normalLoader</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">loader</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#BD976A;">use</span><span style="color:#666666;">[</span><span style="color:#BD976A;">len</span><span style="color:#CB7676;">--</span><span style="color:#666666;">]);</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//从右到左，从下到上</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 进行转换</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">content</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">loader</span><span style="color:#666666;">(</span><span style="color:#BD976A;">content</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 递归遍历所有的loader</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">len</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">&gt;=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">normalLoader</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">normalLoader</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">content</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 模块文件解析 source---文件内容， parentPath---文件目录</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 解析结果：解析的源码sourceCode，以及是否存在子依赖包dependencies</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentPath</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[];</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//存储子模块依赖</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// const code = &quot;const n =1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用babylon来将源码解析成ast</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ast</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">babylon</span><span style="color:#666666;">.</span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">source</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用traverse来遍历AST节点，当访问者进入一个节点时就会调用​enter(进入)​​​方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">traverse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ast</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">CallExpression</span><span style="color:#666666;">(</span><span style="color:#BD976A;">p</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">p</span><span style="color:#666666;">.</span><span style="color:#BD976A;">node</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callee</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">require</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callee</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">__webpack_require__</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 补全拓展名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">arguments</span><span style="color:#666666;">[</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">].</span><span style="color:#BD976A;">value</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 利用path.extname判断模块名是否包含拓展名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">extname</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 使用path.join拼接成相对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#BD976A;">parentPath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">dependencies</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 更新node，将子模块名重写</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">arguments</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">types</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringLiteral</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 利用generator来将ast解析成源码</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">generator</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ast</span><span style="color:#666666;">).</span><span style="color:#BD976A;">code</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log(sourceCode);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log(modulePath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 模块文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">source</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.relative将绝对路径分解成相对路径（返回从第一个路径到第二个路径的相对路径），获取模块名</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">./</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">relative</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">modulePath</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">isEntry</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.dirname来获取模块所在相对目录</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dependencies</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">dirname</span><span style="color:#666666;">(</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 保存解析的代码</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#666666;">[</span><span style="color:#BD976A;">moduleName</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sourceCode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 递归</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">dependencies</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">((</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 使用path.join来拼接成相对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dep</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 生成打包文件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">emitFile</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 打包路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">main</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">output</span><span style="color:#666666;">.</span><span style="color:#BD976A;">path</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">output</span><span style="color:#666666;">.</span><span style="color:#BD976A;">filename</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取模版内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">templateStr</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">getSource</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">join</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">bundle.ejs</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">));</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 调用模版生成</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">result</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ejs</span><span style="color:#666666;">.</span><span style="color:#80A665;">render</span><span style="color:#666666;">(</span><span style="color:#BD976A;">templateStr</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">entryId</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entryId</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">modules</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">modules</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 定义打包文件内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">assets</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">assets</span><span style="color:#666666;">[</span><span style="color:#BD976A;">main</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">result</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//文件全名---文件内容</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 输出打包文件</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log(main);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// console.log( this.assets);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">fs</span><span style="color:#666666;">.</span><span style="color:#80A665;">writeFileSync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">main</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">assets</span><span style="color:#666666;">[</span><span style="color:#BD976A;">main</span><span style="color:#666666;">]);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 执行方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">run</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hooks</span><span style="color:#666666;">.</span><span style="color:#BD976A;">run</span><span style="color:#666666;">.</span><span style="color:#80A665;">call</span><span style="color:#666666;">();</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//消费</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hooks</span><span style="color:#666666;">.</span><span style="color:#BD976A;">compile</span><span style="color:#666666;">.</span><span style="color:#80A665;">call</span><span style="color:#666666;">();</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//编译</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用path.resolve将相对路径拼接成绝对路径</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">buildModule</span><span style="color:#666666;">(</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">),</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hooks</span><span style="color:#666666;">.</span><span style="color:#BD976A;">emit</span><span style="color:#666666;">.</span><span style="color:#80A665;">call</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">emitFile</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hooks</span><span style="color:#666666;">.</span><span style="color:#BD976A;">done</span><span style="color:#666666;">.</span><span style="color:#80A665;">call</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Compiler</span><span style="color:#666666;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fs</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">fs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">path</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">//  babylon @babel/traverse @babel/types @babel/generator</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">babylon</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">babylon</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">types</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/types</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">// require(&quot;xxx&quot;).default,相当于import xxx from &#39;./xxx&#39;</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">traverse</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/traverse</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">).</span><span style="color:#B07D48;">default</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">generator</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">@babel/generator</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">).</span><span style="color:#B07D48;">default</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#A0ADA0;">// 模版引擎</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ejs</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">ejs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">// 发布者订阅模式钩子，观察者</span></span>
<span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">SyncHook</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">tapable</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">emit</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">process</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// 编译器</span></span>
<span class="line"><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E8F82;">Compiler</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 接收webpack.config-js配置内容，进行本地化</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 入口目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 当前工作目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">process</span><span style="color:#999999;">.</span><span style="color:#59873A;">cwd</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 用来保存所有模块</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 钩子</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hooks</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">entryOption</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">SyncHook</span><span style="color:#999999;">(),</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//开始</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">compile</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">SyncHook</span><span style="color:#999999;">(),</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//编译</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">afterCompile</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">SyncHook</span><span style="color:#999999;">(),</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//编译后</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">run</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">SyncHook</span><span style="color:#999999;">(),</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//编译后</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">emit</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">SyncHook</span><span style="color:#999999;">(),</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//发送</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">done</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">SyncHook</span><span style="color:#999999;">(),</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//完成</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">plugin</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">module</span><span style="color:#999999;">.</span><span style="color:#B07D48;">plugins</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">Array</span><span style="color:#999999;">.</span><span style="color:#59873A;">isArray</span><span style="color:#999999;">(</span><span style="color:#B07D48;">plugin</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">plugin</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">((</span><span style="color:#B07D48;">p</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">p</span><span style="color:#999999;">.</span><span style="color:#59873A;">apply</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 读取模块文件内容</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rules</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">module</span><span style="color:#999999;">.</span><span style="color:#B07D48;">rules</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// readFileSync() 同步读取文件</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">content</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fs</span><span style="color:#999999;">.</span><span style="color:#59873A;">readFileSync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">utf-8</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">for</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#393A34;"> </span><span style="color:#999999;">&lt;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rules</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#AB5959;">++</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rule</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rules</span><span style="color:#999999;">[</span><span style="color:#B07D48;">i</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">test</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">use</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rule</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">len</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">use</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">-</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">1</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//loader的总长度-1</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 判断是否为less文件</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">test</span><span style="color:#999999;">.</span><span style="color:#59873A;">test</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">normalLoader</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">loader</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B07D48;">use</span><span style="color:#999999;">[</span><span style="color:#B07D48;">len</span><span style="color:#AB5959;">--</span><span style="color:#999999;">]);</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//从右到左，从下到上</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 进行转换</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">content</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">loader</span><span style="color:#999999;">(</span><span style="color:#B07D48;">content</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 递归遍历所有的loader</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">len</span><span style="color:#393A34;"> </span><span style="color:#999999;">&gt;=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">normalLoader</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">normalLoader</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">content</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 模块文件解析 source---文件内容， parentPath---文件目录</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 解析结果：解析的源码sourceCode，以及是否存在子依赖包dependencies</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentPath</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[];</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//存储子模块依赖</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// const code = &quot;const n =1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用babylon来将源码解析成ast</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ast</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">babylon</span><span style="color:#999999;">.</span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">source</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用traverse来遍历AST节点，当访问者进入一个节点时就会调用​enter(进入)​​​方法</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">traverse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ast</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">CallExpression</span><span style="color:#999999;">(</span><span style="color:#B07D48;">p</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">p</span><span style="color:#999999;">.</span><span style="color:#B07D48;">node</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callee</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">require</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callee</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">__webpack_require__</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 补全拓展名</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">arguments</span><span style="color:#999999;">[</span><span style="color:#2F798A;">0</span><span style="color:#999999;">].</span><span style="color:#B07D48;">value</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 利用path.extname判断模块名是否包含拓展名</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">extname</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 使用path.join拼接成相对路径</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#B07D48;">parentPath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">dependencies</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 更新node，将子模块名重写</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">arguments</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">types</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringLiteral</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)];</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 利用generator来将ast解析成源码</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">generator</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ast</span><span style="color:#999999;">).</span><span style="color:#B07D48;">code</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log(sourceCode);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 从root节点找到所有的依赖模块</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// modulePath---模块文件路径,isEntry---是否是入口文件</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log(modulePath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 模块文件内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">source</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.relative将绝对路径分解成相对路径（返回从第一个路径到第二个路径的相对路径），获取模块名</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">./</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">relative</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">modulePath</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">isEntry</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.dirname来获取模块所在相对目录</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dependencies</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">dirname</span><span style="color:#999999;">(</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 保存解析的代码</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#999999;">[</span><span style="color:#B07D48;">moduleName</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sourceCode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 递归</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">dependencies</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">((</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 使用path.join来拼接成相对路径</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dep</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 生成打包文件</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">emitFile</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 打包路径</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">main</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">output</span><span style="color:#999999;">.</span><span style="color:#B07D48;">path</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">output</span><span style="color:#999999;">.</span><span style="color:#B07D48;">filename</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取模版内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">templateStr</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">getSource</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">join</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">bundle.ejs</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">));</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 调用模版生成</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">result</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ejs</span><span style="color:#999999;">.</span><span style="color:#59873A;">render</span><span style="color:#999999;">(</span><span style="color:#B07D48;">templateStr</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">entryId</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entryId</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">modules</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">modules</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 定义打包文件内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">assets</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">assets</span><span style="color:#999999;">[</span><span style="color:#B07D48;">main</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">result</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//文件全名---文件内容</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 输出打包文件</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log(main);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// console.log( this.assets);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">fs</span><span style="color:#999999;">.</span><span style="color:#59873A;">writeFileSync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">main</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">assets</span><span style="color:#999999;">[</span><span style="color:#B07D48;">main</span><span style="color:#999999;">]);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 执行方法</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">run</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hooks</span><span style="color:#999999;">.</span><span style="color:#B07D48;">run</span><span style="color:#999999;">.</span><span style="color:#59873A;">call</span><span style="color:#999999;">();</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//消费</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hooks</span><span style="color:#999999;">.</span><span style="color:#B07D48;">compile</span><span style="color:#999999;">.</span><span style="color:#59873A;">call</span><span style="color:#999999;">();</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//编译</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用path.resolve将相对路径拼接成绝对路径</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">buildModule</span><span style="color:#999999;">(</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">),</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hooks</span><span style="color:#999999;">.</span><span style="color:#B07D48;">emit</span><span style="color:#999999;">.</span><span style="color:#59873A;">call</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">emitFile</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hooks</span><span style="color:#999999;">.</span><span style="color:#B07D48;">done</span><span style="color:#999999;">.</span><span style="color:#59873A;">call</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Compiler</span><span style="color:#999999;">;</span></span></code></pre></div><br><h4 id="执行结果" tabindex="-1">执行结果 <a class="header-anchor" href="#执行结果" aria-label="Permalink to &quot;执行结果&quot;">​</a></h4><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900925.png" alt="image-20230726012715888"></p><br><br><h2 id="最终目录结构" tabindex="-1">最终目录结构 <a class="header-anchor" href="#最终目录结构" aria-label="Permalink to &quot;最终目录结构&quot;">​</a></h2><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900008.png" alt="image-20230726012759264"></p><br><br><h2 id="webpack-打包优化" tabindex="-1">webpack 打包优化 <a class="header-anchor" href="#webpack-打包优化" aria-label="Permalink to &quot;webpack 打包优化&quot;">​</a></h2><h3 id="优化前" tabindex="-1">优化前 <a class="header-anchor" href="#优化前" aria-label="Permalink to &quot;优化前&quot;">​</a></h3><blockquote><h3 id="启动" tabindex="-1">启动 <a class="header-anchor" href="#启动" aria-label="Permalink to &quot;启动&quot;">​</a></h3></blockquote><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900116.png" alt="image-20230801214104154"></p><blockquote><h3 id="打包" tabindex="-1">打包 <a class="header-anchor" href="#打包" aria-label="Permalink to &quot;打包&quot;">​</a></h3></blockquote><p><strong>首次打包速度</strong></p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900787.png" alt="image-20230801214239842"></p><p><strong>二次打包速度</strong></p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900688.png" alt="image-20230801214506769"></p><p><strong>打包大小</strong></p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900840.png" alt="image-20230801214747258"></p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900455.png" alt="image-20230801215039665"></p><br><h3 id="分析打包时间与大小结果" tabindex="-1"><strong>分析打包时间与大小结果</strong> <a class="header-anchor" href="#分析打包时间与大小结果" aria-label="Permalink to &quot;**分析打包时间与大小结果**&quot;">​</a></h3><p>speed-measure-webpack-plugin、webpack-bundle-analyzer</p><blockquote><p>第一步：安装 speed-measure-webpack-plugin、webpack-bundle-analyzer（vue-Cli 自带）</p></blockquote><p><code>npm install speed-measure-webpack-plugin --save-dev </code></p><p>\`\`npm install webpack-bundle-analyzer --save-dev <code></code></p><blockquote><p>第二步：在 vue.config.js 文件中引入</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">BundleAnalyzerPlugin</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">webpack-bundle-analyzer</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">).</span><span style="color:#BD976A;">BundleAnalyzerPlugin</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">SpeedMeasurePlugin</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">speed-measure-webpack-plugin</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">);</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">BundleAnalyzerPlugin</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">webpack-bundle-analyzer</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">).</span><span style="color:#B07D48;">BundleAnalyzerPlugin</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">SpeedMeasurePlugin</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">speed-measure-webpack-plugin</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">);</span></span></code></pre></div><blockquote><p>第三步：在 webpack 配置中使用该插件</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">......</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">configureWebpack</span><span style="color:#DBD7CAEE;">: </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">plugins</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 这个要放在所有 plugins 最后</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">BundleAnalyzerPlugin</span><span style="color:#666666;">(),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">SpeedMeasurePlugin</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">]</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">}</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">......</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">configureWebpack</span><span style="color:#393A34;">: </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">plugins</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 这个要放在所有 plugins 最后</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">BundleAnalyzerPlugin</span><span style="color:#999999;">(),</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">SpeedMeasurePlugin</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">]</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">}</span></span></code></pre></div><br><h3 id="生产模式去掉-console" tabindex="-1">生产模式去掉 console <a class="header-anchor" href="#生产模式去掉-console" aria-label="Permalink to &quot;生产模式去掉 console&quot;">​</a></h3><blockquote><p>修改 vue.config.js 文件</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">......</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">chainWebpack</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">config</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#80A665;">plugin</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">html</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">).</span><span style="color:#80A665;">tap</span><span style="color:#666666;">(</span><span style="color:#BD976A;">args</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">args</span><span style="color:#666666;">[</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">].</span><span style="color:#BD976A;">title</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">title</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">args</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">process</span><span style="color:#666666;">.</span><span style="color:#BD976A;">env</span><span style="color:#666666;">.</span><span style="color:#BD976A;">NODE_ENV</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">production</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// //生产包取消console debugger打印</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">optimization</span><span style="color:#666666;">.</span><span style="color:#80A665;">minimizer</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">terser</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">).</span><span style="color:#80A665;">tap</span><span style="color:#666666;">((</span><span style="color:#BD976A;">args</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 注释console.*</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">args</span><span style="color:#666666;">[</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">].</span><span style="color:#BD976A;">terserOptions</span><span style="color:#666666;">.</span><span style="color:#BD976A;">compress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">drop_console</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// remove debugger</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">args</span><span style="color:#666666;">[</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">].</span><span style="color:#BD976A;">terserOptions</span><span style="color:#666666;">.</span><span style="color:#BD976A;">compress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">drop_debugger</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 移除 console.log</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">args</span><span style="color:#666666;">[</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">].</span><span style="color:#BD976A;">terserOptions</span><span style="color:#666666;">.</span><span style="color:#BD976A;">compress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pure_funcs</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">console.log</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">]</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 去掉注释</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">args</span><span style="color:#666666;">[</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">].</span><span style="color:#BD976A;">terserOptions</span><span style="color:#666666;">.</span><span style="color:#BD976A;">output</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#B8A965;">comments</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">               </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">args</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">......</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">chainWebpack</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">config</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#59873A;">plugin</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">html</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">).</span><span style="color:#59873A;">tap</span><span style="color:#999999;">(</span><span style="color:#B07D48;">args</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">args</span><span style="color:#999999;">[</span><span style="color:#2F798A;">0</span><span style="color:#999999;">].</span><span style="color:#B07D48;">title</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">title</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">args</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">process</span><span style="color:#999999;">.</span><span style="color:#B07D48;">env</span><span style="color:#999999;">.</span><span style="color:#B07D48;">NODE_ENV</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">production</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// //生产包取消console debugger打印</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">optimization</span><span style="color:#999999;">.</span><span style="color:#59873A;">minimizer</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">terser</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">).</span><span style="color:#59873A;">tap</span><span style="color:#999999;">((</span><span style="color:#B07D48;">args</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 注释console.*</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">args</span><span style="color:#999999;">[</span><span style="color:#2F798A;">0</span><span style="color:#999999;">].</span><span style="color:#B07D48;">terserOptions</span><span style="color:#999999;">.</span><span style="color:#B07D48;">compress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">drop_console</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// remove debugger</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">args</span><span style="color:#999999;">[</span><span style="color:#2F798A;">0</span><span style="color:#999999;">].</span><span style="color:#B07D48;">terserOptions</span><span style="color:#999999;">.</span><span style="color:#B07D48;">compress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">drop_debugger</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 移除 console.log</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">args</span><span style="color:#999999;">[</span><span style="color:#2F798A;">0</span><span style="color:#999999;">].</span><span style="color:#B07D48;">terserOptions</span><span style="color:#999999;">.</span><span style="color:#B07D48;">compress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pure_funcs</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">console.log</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">]</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 去掉注释</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">args</span><span style="color:#999999;">[</span><span style="color:#2F798A;">0</span><span style="color:#999999;">].</span><span style="color:#B07D48;">terserOptions</span><span style="color:#999999;">.</span><span style="color:#B07D48;">output</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#998418;">comments</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">               </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">args</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;"> </span><span style="color:#999999;">}</span></span></code></pre></div><br><br><h3 id="提供中间缓存" tabindex="-1">提供中间缓存 <a class="header-anchor" href="#提供中间缓存" aria-label="Permalink to &quot;提供中间缓存&quot;">​</a></h3><h4 id="hardsourcewebpackplugin" tabindex="-1">HardSourceWebpackPlugin <a class="header-anchor" href="#hardsourcewebpackplugin" aria-label="Permalink to &quot;HardSourceWebpackPlugin&quot;">​</a></h4><blockquote><p><code>HardSourceWebpackPlugin</code> 为模块提供中间缓存，缓存默认的存放路径是: <code>node_modules/.cache/hard-source</code>。</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HardSourceWebpackPlugin</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">hard-source-webpack-plugin</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">......</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">configureWebpack</span><span style="color:#DBD7CAEE;">: </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">plugins</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">HardSourceWebpackPlugin</span><span style="color:#666666;">(),</span><span style="color:#DBD7CAEE;">  </span><span style="color:#758575DD;">// 模块提供中间缓存</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#666666;">}</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HardSourceWebpackPlugin</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">hard-source-webpack-plugin</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">......</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">configureWebpack</span><span style="color:#393A34;">: </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">plugins</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">HardSourceWebpackPlugin</span><span style="color:#999999;">(),</span><span style="color:#393A34;">  </span><span style="color:#A0ADA0;">// 模块提供中间缓存</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#999999;">}</span></span></code></pre></div><br><br><h3 id="确保转译尽可能少的文件" tabindex="-1">确保转译尽可能少的文件 <a class="header-anchor" href="#确保转译尽可能少的文件" aria-label="Permalink to &quot;确保转译尽可能少的文件&quot;">​</a></h3><h4 id="exclude-include" tabindex="-1">exclude/include <a class="header-anchor" href="#exclude-include" aria-label="Permalink to &quot;exclude/include&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">......</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">configureWebpack</span><span style="color:#DBD7CAEE;">: </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">         </span><span style="color:#B8A965;">module</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#B8A965;">rules</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#B8A965;">test</span><span style="color:#666666;">:</span><span style="color:#C4704F;"> </span><span style="color:#C98A7D99;">/</span><span style="color:#E6CC77;">\\.</span><span style="color:#C4704F;">js</span><span style="color:#666666;">[</span><span style="color:#C99076;">x</span><span style="color:#666666;">]</span><span style="color:#CB7676;">?</span><span style="color:#4D9375;">$</span><span style="color:#C98A7D99;">/</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#B8A965;">use</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">babel-loader</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#B8A965;">include</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">src</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)]</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">]</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#666666;">}</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">......</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">configureWebpack</span><span style="color:#393A34;">: </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">         </span><span style="color:#998418;">module</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#998418;">rules</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#998418;">test</span><span style="color:#999999;">:</span><span style="color:#AB5E3F;"> </span><span style="color:#B5695999;">/</span><span style="color:#BDA437;">\\.</span><span style="color:#AB5E3F;">js</span><span style="color:#999999;">[</span><span style="color:#A65E2B;">x</span><span style="color:#999999;">]</span><span style="color:#AB5959;">?</span><span style="color:#1E754F;">$</span><span style="color:#B5695999;">/</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#998418;">use</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">babel-loader</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#998418;">include</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">src</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)]</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">]</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#999999;">}</span></span></code></pre></div><br><br><h3 id="使用-cdn-方法引入包" tabindex="-1">使用 CDN 方法引入包 <a class="header-anchor" href="#使用-cdn-方法引入包" aria-label="Permalink to &quot;使用 CDN 方法引入包&quot;">​</a></h3><h4 id="cdn" tabindex="-1">CDN <a class="header-anchor" href="#cdn" aria-label="Permalink to &quot;CDN&quot;">​</a></h4><blockquote><p>在 public/index.html 中加入 echart 的 cdn 资源</p></blockquote><div class="language-html vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#666666;">&lt;</span><span style="color:#4D9375;">script</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">src</span><span style="color:#666666;">=</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.1/echarts.min.js</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">&gt;&lt;/</span><span style="color:#4D9375;">script</span><span style="color:#666666;">&gt;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#999999;">&lt;</span><span style="color:#1E754F;">script</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">src</span><span style="color:#999999;">=</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.1/echarts.min.js</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">&gt;&lt;/</span><span style="color:#1E754F;">script</span><span style="color:#999999;">&gt;</span></span></code></pre></div><blockquote><p>在 vue.config.js 中配置 CDN 的使用</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">......</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">configureWebpack</span><span style="color:#DBD7CAEE;">: </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">         </span><span style="color:#B8A965;">externals</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#B8A965;">echarts</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">echarts</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 配置使用CDN</span></span>
<span class="line"><span style="color:#DBD7CAEE;">		</span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#666666;">}</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">......</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">configureWebpack</span><span style="color:#393A34;">: </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">         </span><span style="color:#998418;">externals</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#998418;">echarts</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">echarts</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 配置使用CDN</span></span>
<span class="line"><span style="color:#393A34;">		</span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#999999;">}</span></span></code></pre></div><br><br><h3 id="多线程编译" tabindex="-1">多线程编译 <a class="header-anchor" href="#多线程编译" aria-label="Permalink to &quot;多线程编译&quot;">​</a></h3><h4 id="thread-loader" tabindex="-1">thread-loader <a class="header-anchor" href="#thread-loader" aria-label="Permalink to &quot;thread-loader&quot;">​</a></h4><blockquote><p>开启多线程编译</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">os</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">require</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">os</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">// cpu核数</span></span>
<span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">threads</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">os</span><span style="color:#666666;">.</span><span style="color:#80A665;">cpus</span><span style="color:#666666;">().</span><span style="color:#B8A965;">length</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">......</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">chainWebpack</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">config</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 多核编译</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">module</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">.</span><span style="color:#80A665;">rule</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">vue</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">.</span><span style="color:#80A665;">use</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">thread-loader</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">.</span><span style="color:#80A665;">loader</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">thread-loader</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">.</span><span style="color:#80A665;">options</span><span style="color:#666666;">({</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">workers</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">threads</span><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">.</span><span style="color:#80A665;">end</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">module</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">.</span><span style="color:#80A665;">rule</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">js</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">.</span><span style="color:#80A665;">use</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">thread-loader</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">.</span><span style="color:#80A665;">loader</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">thread-loader</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">.</span><span style="color:#80A665;">options</span><span style="color:#666666;">({</span><span style="color:#B8A965;">workers</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">threads</span><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">.</span><span style="color:#80A665;">end</span><span style="color:#666666;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">process</span><span style="color:#666666;">.</span><span style="color:#BD976A;">env</span><span style="color:#666666;">.</span><span style="color:#BD976A;">NODE_ENV</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">production</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">optimization</span><span style="color:#666666;">.</span><span style="color:#80A665;">minimizer</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">terser</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">).</span><span style="color:#80A665;">tap</span><span style="color:#666666;">((</span><span style="color:#BD976A;">args</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">args</span><span style="color:#666666;">[</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">].</span><span style="color:#BD976A;">parallel</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">threads</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">               </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">args</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#666666;">}</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">os</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">require</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">os</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">// cpu核数</span></span>
<span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">threads</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">os</span><span style="color:#999999;">.</span><span style="color:#59873A;">cpus</span><span style="color:#999999;">().</span><span style="color:#998418;">length</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">......</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">chainWebpack</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">config</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 多核编译</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">module</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">.</span><span style="color:#59873A;">rule</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">vue</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">.</span><span style="color:#59873A;">use</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">thread-loader</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">.</span><span style="color:#59873A;">loader</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">thread-loader</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">.</span><span style="color:#59873A;">options</span><span style="color:#999999;">({</span><span style="color:#393A34;"> </span><span style="color:#998418;">workers</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">threads</span><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">.</span><span style="color:#59873A;">end</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">module</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">.</span><span style="color:#59873A;">rule</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">js</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">.</span><span style="color:#59873A;">use</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">thread-loader</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">.</span><span style="color:#59873A;">loader</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">thread-loader</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">.</span><span style="color:#59873A;">options</span><span style="color:#999999;">({</span><span style="color:#998418;">workers</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">threads</span><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">.</span><span style="color:#59873A;">end</span><span style="color:#999999;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">process</span><span style="color:#999999;">.</span><span style="color:#B07D48;">env</span><span style="color:#999999;">.</span><span style="color:#B07D48;">NODE_ENV</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">production</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">optimization</span><span style="color:#999999;">.</span><span style="color:#59873A;">minimizer</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">terser</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">).</span><span style="color:#59873A;">tap</span><span style="color:#999999;">((</span><span style="color:#B07D48;">args</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">args</span><span style="color:#999999;">[</span><span style="color:#2F798A;">0</span><span style="color:#999999;">].</span><span style="color:#B07D48;">parallel</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">threads</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">               </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">args</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#999999;">}</span></span></code></pre></div><br><br><h3 id="编译缓存" tabindex="-1">编译缓存 <a class="header-anchor" href="#编译缓存" aria-label="Permalink to &quot;编译缓存&quot;">​</a></h3><h4 id="使用文件缓存-加速二次构建" tabindex="-1">使用文件缓存，加速二次构建 <a class="header-anchor" href="#使用文件缓存-加速二次构建" aria-label="Permalink to &quot;使用文件缓存，加速二次构建&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">......</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">configureWebpack</span><span style="color:#DBD7CAEE;">: </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">cache</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 使用文件缓存，加速二次构建</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#B8A965;">type</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">filesystem</span><span style="color:#C98A7D99;">&#39;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  	</span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">......</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">configureWebpack</span><span style="color:#393A34;">: </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">cache</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 使用文件缓存，加速二次构建</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#998418;">type</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">filesystem</span><span style="color:#B5695999;">&#39;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  	</span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span></code></pre></div><br><br><h3 id="优化后" tabindex="-1">优化后 <a class="header-anchor" href="#优化后" aria-label="Permalink to &quot;优化后&quot;">​</a></h3><h4 id="启动-1" tabindex="-1">启动 <a class="header-anchor" href="#启动-1" aria-label="Permalink to &quot;启动&quot;">​</a></h4><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900322.png" alt="image-20230801215832483"></p><h4 id="打包-1" tabindex="-1">打包 <a class="header-anchor" href="#打包-1" aria-label="Permalink to &quot;打包&quot;">​</a></h4><p><strong>首次打包</strong></p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900107.png" alt="image-20230801221421232"></p><p><strong>二次打包</strong></p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900948.png" alt="image-20230801210607743"></p><p><img src="https://cdn.jsdelivr.net/gh/LAOVA/Typora_images@main/img/202310151900486.png" alt="image-20230801210627049"></p><br><h3 id="优化结果" tabindex="-1">优化结果 <a class="header-anchor" href="#优化结果" aria-label="Permalink to &quot;优化结果&quot;">​</a></h3><blockquote><h3 id="启动-2" tabindex="-1">启动 <a class="header-anchor" href="#启动-2" aria-label="Permalink to &quot;启动&quot;">​</a></h3></blockquote><p><strong>启动时间速度提高<code>130%</code></strong></p><blockquote><h3 id="打包-2" tabindex="-1">打包 <a class="header-anchor" href="#打包-2" aria-label="Permalink to &quot;打包&quot;">​</a></h3></blockquote><p>首次打包速度提高 25%、二次打包速度提高 72%</p><p><strong>综合打包速度提高<code>48.5%</code></strong></p><p><strong>打包体积缩小<code>43%</code></strong></p>`,252),e=[o];function c(t,r,y,A,D,i){return n(),a("div",null,e)}const C=s(p,[["render",c]]);export{E as __pageData,C as default};
